<Page
    x:Class="UsageLogger.Views.DayAppUsagePage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:l="using:WinUI3Localizer"
    xmlns:controls="using:UsageLogger.Controls"
    mc:Ignorable="d">

    <Page.Resources>
        <DataTemplate x:Key="AppUsageItemTemplate">
            <Border CornerRadius="12" Background="{Binding BrushAppTagBg}" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" Padding="0" Margin="0,0,10,10">
                <Border.ContextFlyout>
                    <MenuFlyout Opening="MenuFlyout_Opening">
                        <MenuFlyoutItem l:Uids.Uid="Dashboard_SetTimeLimit" Click="MenuFlyoutItem_SetTimeLimit_Click" Tag="{Binding ProcessName}">
                            <MenuFlyoutItem.Icon>
                                <FontIcon Glyph="&#xE823;"/>
                            </MenuFlyoutItem.Icon>
                        </MenuFlyoutItem>
                        <MenuFlyoutSubItem l:Uids.Uid="Dashboard_SetCategory" Tag="SetCategory_SubItem">
                            <MenuFlyoutSubItem.Icon>
                                <FontIcon Glyph="&#xE8EC;"/>
                            </MenuFlyoutSubItem.Icon>
                        </MenuFlyoutSubItem>
                        <MenuFlyoutSeparator/>
                        <MenuFlyoutItem l:Uids.Uid="Dashboard_SetDisplayName" Click="MenuFlyoutItem_SetDisplayName_Click" Tag="{Binding ProcessName}">
                            <MenuFlyoutItem.Icon>
                                <FontIcon Glyph="&#xE8AC;"/>
                            </MenuFlyoutItem.Icon>
                        </MenuFlyoutItem>
                        <MenuFlyoutItem l:Uids.Uid="Dashboard_SetCustomIcon" Click="MenuFlyoutItem_SetCustomIcon_Click" Tag="{Binding ProcessName}">
                            <MenuFlyoutItem.Icon>
                                <FontIcon Glyph="&#xE8B9;"/>
                            </MenuFlyoutItem.Icon>
                        </MenuFlyoutItem>
                        <MenuFlyoutItem l:Uids.Uid="Dashboard_ExcludeApp" Click="MenuFlyoutItem_ExcludeApp_Click" Tag="{Binding ProcessName}">
                            <MenuFlyoutItem.Icon>
                                <FontIcon Glyph="&#xE74D;"/>
                            </MenuFlyoutItem.Icon>
                        </MenuFlyoutItem>
                    </MenuFlyout>
                </Border.ContextFlyout>
                
                <StackPanel>
                    <Grid Height="60" Padding="15,0" RightTapped="Grid_RightTapped" Background="Transparent" ToolTipService.ToolTip="Click to expand details">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- Toggle Button (Invisible but clickable overlay) -->
                        <Button Background="Transparent" BorderThickness="0" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" Grid.ColumnSpan="4" Command="{Binding ToggleExpandCommand}" Margin="-15,0"/>

                        <!-- Icon -->
                        <Image Source="{Binding IconSource}" Width="32" Height="32" VerticalAlignment="Center" Margin="0,0,15,0" IsHitTestVisible="False"/>

                        <!-- Name & Tag -->
                        <StackPanel Grid.Column="1" VerticalAlignment="Center" IsHitTestVisible="False">
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                <TextBlock Text="{Binding DisplayName}" FontWeight="SemiBold" FontSize="15" Margin="0,0,10,0"/>
                                <Grid VerticalAlignment="Center" CornerRadius="8">
                                    <Border Background="{Binding BrushAppTagInnerBg}" CornerRadius="8"/>
                                    <Border Padding="8,2" BorderBrush="{Binding BrushAppTag}" BorderThickness="0">
                                        <TextBlock Text="{Binding StrAppTag}" Foreground="White" FontSize="11" FontWeight="Bold"/>
                                    </Border>
                                </Grid>
                            </StackPanel>
                            
                            <ProgressBar Value="{Binding Percentage}" Maximum="100" Height="4" CornerRadius="2" HorizontalAlignment="Stretch" Margin="0,0,10,0"/>
                        </StackPanel>

                        <!-- Duration -->
                        <TextBlock Grid.Column="2" Text="{Binding StrDuration}" VerticalAlignment="Center" HorizontalAlignment="Right" FontWeight="SemiBold" FontSize="14" Margin="10,0,10,0" IsHitTestVisible="False"/>
                        
                        <!-- Expand Chevron -->
                        <FontIcon Grid.Column="3" Glyph="&#xE70D;" FontSize="12" Opacity="0.5" VerticalAlignment="Center" IsHitTestVisible="False" Visibility="{Binding HasChildren, Converter={StaticResource BoolToVisibilityConverter}}">
                            <FontIcon.RenderTransform>
                                <RotateTransform Angle="{Binding ChevronRotation}" CenterX="6" CenterY="6"/>
                            </FontIcon.RenderTransform>
                        </FontIcon>
                    </Grid>

                    <!-- Accordion Body -->
                    <!-- Accordion Body -->
                    <!-- Accordion Body -->
                    <!-- Removed redundant ScrollViewer -->
                    <ListView ItemsSource="{Binding Children}" SelectionMode="Single" MaxHeight="250"
                              Visibility="{Binding IsExpanded, Converter={StaticResource BoolToVisibilityConverter}}">
                        <ListView.ItemContainerStyle>
                            <Style TargetType="ListViewItem">
                                <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                <Setter Property="Padding" Value="0"/>
                                <Setter Property="MinHeight" Value="0"/>
                            </Style>
                        </ListView.ItemContainerStyle>
                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="60,4,15,4" Background="{Binding BackgroundBrush}" CornerRadius="4" Margin="4,2" ToolTipService.ToolTip="Right-click to Tag">
                                    <Grid.ContextFlyout>
                                        <MenuFlyout Opening="SubItemMenuFlyout_Opening">
                                            <MenuFlyoutItem Text="Set Category (Tag)" Click="SubItemMenuFlyoutItem_SetTag_Click">
                                                <MenuFlyoutItem.Icon>
                                                    <FontIcon Glyph="&#xE8EC;"/>
                                                </MenuFlyoutItem.Icon>
                                            </MenuFlyoutItem>
                                            <MenuFlyoutItem Text="Set Display Name..." Click="SubItemMenuFlyoutItem_SetDisplayName_Click">
                                                <MenuFlyoutItem.Icon>
                                                    <FontIcon Glyph="&#xE8AC;"/>
                                                </MenuFlyoutItem.Icon>
                                            </MenuFlyoutItem>
                                            <MenuFlyoutItem Text="Set Time Limit" Click="SubItemMenuFlyoutItem_SetTimeLimit_Click">
                                                <MenuFlyoutItem.Icon>
                                                    <FontIcon Glyph="&#xE823;"/>
                                                </MenuFlyoutItem.Icon>
                                            </MenuFlyoutItem>
                                            <MenuFlyoutSeparator/>
                                            <MenuFlyoutItem Text="Exclude" Click="SubItemMenuFlyoutItem_Exclude_Click">
                                                <MenuFlyoutItem.Icon>
                                                    <FontIcon Glyph="&#xE74D;"/>
                                                </MenuFlyoutItem.Icon>
                                            </MenuFlyoutItem>
                                        </MenuFlyout>
                                    </Grid.ContextFlyout>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="100"/>
                                        <ColumnDefinition Width="80"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <StackPanel Orientation="Horizontal" Grid.Column="0" Spacing="8">
                                        <Rectangle Width="4" Height="16" Fill="{Binding TagIndicatorBrush}" RadiusX="2" RadiusY="2" VerticalAlignment="Center"/>
                                        
                                        <!-- No icon for subitems -->
                                        <!-- <Image Source="{Binding IconSource}" Width="16" Height="16" VerticalAlignment="Center"/> -->
                                        
                                        <TextBlock Text="{Binding Title}" VerticalAlignment="Center" TextTrimming="CharacterEllipsis" FontSize="12"/> 
                                    </StackPanel>

                                    <ProgressBar Grid.Column="1" Value="{Binding Percentage}" Maximum="100" Height="4" VerticalAlignment="Center" Margin="10,0"/>

                                    <TextBlock Grid.Column="2" Text="{Binding StrDuration}" VerticalAlignment="Center" HorizontalAlignment="Right" FontSize="12" Opacity="0.7"/>
                                </Grid>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                </StackPanel>
            </Border>
        </DataTemplate>
        <Storyboard x:Name="RefreshButtonAnimation">
            <DoubleAnimation
                Storyboard.TargetName="RefreshIconRotation"
                Storyboard.TargetProperty="Angle"
                From="0" To="360" Duration="0:0:1"
                RepeatBehavior="Forever" />
        </Storyboard>
    </Page.Resources>

    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <Grid Padding="20">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <Grid Grid.Row="0" Margin="0,0,0,20">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Orientation="Horizontal" HorizontalAlignment="Left" VerticalAlignment="Center">
                    <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="12" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" Padding="15,10">
                        <StackPanel Orientation="Horizontal">
                            <Button Background="Transparent" VerticalAlignment="Center" BorderThickness="0" Padding="0" Margin="0,0,10,0" ToolTipService.ToolTip="Select Date">
                                <TextBlock Text="ðŸ“…" VerticalAlignment="Center"/>
                                <Button.Flyout>
                                    <Flyout x:Name="CalendarFlyout" Placement="Bottom">
                                        <CalendarView x:Name="CalendarPicker" SelectionMode="Single" SelectedDatesChanged="CalendarPicker_SelectedDatesChanged" />
                                    </Flyout>
                                </Button.Flyout>
                            </Button>
                            <TextBlock Text="{x:Bind ViewModel.StrLoadedDate, Mode=OneWay}" Style="{ThemeResource TitleTextBlockStyle}" FontSize="18" VerticalAlignment="Center" Width="250" TextAlignment="Center"/>
                            <Button Content="&lt;" Command="{x:Null}" IsEnabled="{x:Bind ViewModel.CanGoPrev, Mode=OneWay}" Click="BtnPrev_Click" Background="Transparent" BorderThickness="0" Margin="10,0,0,0"/>
                            <Button Content="&gt;" Command="{x:Null}" IsEnabled="{x:Bind ViewModel.CanGoNext, Mode=OneWay}" Click="BtnNext_Click" Background="Transparent" BorderThickness="0"/>
                        </StackPanel>
                    </Border>
                    
                    <!-- Total Duration Label + Trend -->
                    <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="12" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" Padding="15,10" Margin="10,0,0,0" VerticalAlignment="Center">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock l:Uids.Uid="Dashboard_Total" Opacity="0.6" VerticalAlignment="Center"/>
                            <TextBlock Text="{x:Bind ViewModel.StrTotalDuration, Mode=OneWay}" FontWeight="SemiBold" VerticalAlignment="Center"/>
                            
                            <!-- Trend Indicator -->
                            <StackPanel Orientation="Horizontal" Margin="12,0,0,0" VerticalAlignment="Center" ToolTipService.ToolTip="{x:Bind ViewModel.TrendDescription, Mode=OneWay}">
                                <TextBlock Text="{x:Bind ViewModel.TrendPercentage, Mode=OneWay}" FontWeight="Bold" Foreground="{x:Bind GetTrendBrush(ViewModel.TrendIsGood), Mode=OneWay}"/>
                                <TextBlock Text="{x:Bind ViewModel.TrendDescription, Mode=OneWay}" Opacity="0.6" Margin="6,0,0,0" FontSize="12" VerticalAlignment="Center"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>
                </StackPanel>

                <!-- Refresh Button -->
                <Button x:Name="BtnRefresh" Grid.Column="1" Click="BtnRefresh_Click" 
                        l:Uids.Uid="Dashboard_RefreshButton"
                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" 
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" 
                        BorderThickness="1" CornerRadius="12" Padding="12,8"
                        VerticalAlignment="Center">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon x:Name="RefreshIcon" Glyph="&#xE72C;" FontSize="16">
                            <FontIcon.RenderTransform>
                                <RotateTransform x:Name="RefreshIconRotation" CenterX="8" CenterY="8"/>
                            </FontIcon.RenderTransform>
                        </FontIcon>
                        <TextBlock l:Uids.Uid="Dashboard_Refresh" VerticalAlignment="Center" FontWeight="SemiBold"/>
                    </StackPanel>
                </Button>
            </Grid>

            <!-- ROW 1: CHARTS (Side by Side) -->
            <Grid Grid.Row="1" Margin="0,0,0,20">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="2*"/>
                    <ColumnDefinition Width="1*"/>
                </Grid.ColumnDefinitions>

                <!-- Bar Chart -->
                <Border Grid.Column="0" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="12" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" Padding="15" Margin="0,0,10,0">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="250"/> 
                        </Grid.RowDefinitions>
                        <TextBlock l:Uids.Uid="Dashboard_DailyActivity" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,10"/>
                        <controls:Win2DBarChart x:Name="BarChartContainer" Grid.Row="1" ItemsSource="{x:Bind ViewModel.WeeklyChartItems, Mode=OneWay}" 
                                        ItemClickCommand="{x:Bind ViewModel.BarChartClickCommand, Mode=OneWay}"
                                        HorizontalContentAlignment="Stretch" VerticalContentAlignment="Stretch" Height="250"/>
                    </Grid>
                </Border>

                <!-- Pie Chart -->
                <Border Grid.Column="1" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="12" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" Padding="15" Margin="10,0,0,0">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="250"/> 
                        </Grid.RowDefinitions>
                        <TextBlock l:Uids.Uid="Dashboard_UsageSummary" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,10"/>
                        <controls:Win2DPieChart x:Name="PieChartContainer" Grid.Row="1" ItemsSource="{x:Bind ViewModel.PieChartItems, Mode=OneWay}" HorizontalContentAlignment="Stretch" VerticalContentAlignment="Stretch"/>
                    </Grid>
                </Border>
            </Grid>

            <!-- EMPTY STATE OVERLAY (shown when no data) -->
            <Border x:Name="EmptyStatePanel" Grid.Row="1" Grid.RowSpan="2"
                    Visibility="{x:Bind IsDashboardEmpty(ViewModel.DayListItems.Count), Mode=OneWay}"
                    Background="{ThemeResource LayerOnMicaBaseAltFillColorDefaultBrush}"
                    CornerRadius="12" Padding="40" Margin="0,0,0,20"
                    HorizontalAlignment="Center" VerticalAlignment="Center">
                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="16" MaxWidth="420">
                    <FontIcon Glyph="&#xE7F4;" FontSize="48" Opacity="0.4" HorizontalAlignment="Center"/>
                    <TextBlock l:Uids.Uid="Dashboard_EmptyTitle"
                               FontSize="22" FontWeight="SemiBold" 
                               HorizontalAlignment="Center" TextAlignment="Center"/>
                    <TextBlock l:Uids.Uid="Dashboard_EmptyDesc"
                               FontSize="14" Opacity="0.6" 
                               HorizontalAlignment="Center" TextAlignment="Center" TextWrapping="Wrap"/>
                    <Button l:Uids.Uid="Dashboard_EmptySettingsBtn"
                            Click="BtnGoToSettings_Click"
                            HorizontalAlignment="Center" 
                            Style="{ThemeResource AccentButtonStyle}"
                            Padding="16,10" CornerRadius="8" Margin="0,8,0,0">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE713;" FontSize="16"/>
                            <TextBlock l:Uids.Uid="Dashboard_EmptySettingsBtnText" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Border>

            <!-- ROW 2: TAB VIEW -->
            <TabView x:Name="TabViewMode"
                     Grid.Row="2" Margin="0,10,0,0" 
                     CanDragTabs="False" 
                     CanReorderTabs="False" 
                     IsAddTabButtonVisible="False" 
                     TabWidthMode="Equal">
                <TabView.TabItems>
                    <TabViewItem l:Uids.Uid="Dashboard_TabActiveWindows" IsClosable="False">
                        <Grid ColumnSpacing="10" Padding="10">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <!-- Column 1 -->
                            <ItemsControl Grid.Column="0" ItemsSource="{x:Bind ViewModel.Column1Items, Mode=OneWay}" ItemTemplate="{StaticResource AppUsageItemTemplate}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <StackPanel Spacing="0"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                            </ItemsControl>

                            <!-- Column 2 -->
                            <ItemsControl Grid.Column="1" ItemsSource="{x:Bind ViewModel.Column2Items, Mode=OneWay}" ItemTemplate="{StaticResource AppUsageItemTemplate}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <StackPanel Spacing="0"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                            </ItemsControl>

                            <!-- Column 3 -->
                            <ItemsControl Grid.Column="2" ItemsSource="{x:Bind ViewModel.Column3Items, Mode=OneWay}" ItemTemplate="{StaticResource AppUsageItemTemplate}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <StackPanel Spacing="0"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                            </ItemsControl>
                        </Grid>
                    </TabViewItem>

                    <!-- Tab 2: Background Audio -->
                    <TabViewItem l:Uids.Uid="Dashboard_TabBackgroundAudio" IsClosable="False">
                        <Grid ColumnSpacing="10" Padding="10">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <!-- Description text -->
                            <TextBlock Grid.Row="0" Grid.ColumnSpan="3" 
                                      l:Uids.Uid="Dashboard_AudioDesc"
                                      Opacity="0.6" 
                                      Margin="0,0,0,12" 
                                      FontSize="14"/>

                            <!-- Column 1 -->
                            <ScrollViewer Grid.Row="1" Grid.Column="0" VerticalScrollBarVisibility="Auto">
                                <ItemsControl ItemsSource="{x:Bind ViewModel.BackgroundAudioColumn1, Mode=OneWay}" 
                                             ItemTemplate="{StaticResource AppUsageItemTemplate}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <StackPanel Spacing="0"/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                </ItemsControl>
                            </ScrollViewer>

                            <!-- Column 2 -->
                            <ScrollViewer Grid.Row="1" Grid.Column="1" VerticalScrollBarVisibility="Auto">
                                <ItemsControl ItemsSource="{x:Bind ViewModel.BackgroundAudioColumn2, Mode=OneWay}" 
                                             ItemTemplate="{StaticResource AppUsageItemTemplate}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <StackPanel Spacing="0"/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                </ItemsControl>
                            </ScrollViewer>

                            <!-- Column 3 -->
                            <ScrollViewer Grid.Row="1" Grid.Column="2" VerticalScrollBarVisibility="Auto">
                                <ItemsControl ItemsSource="{x:Bind ViewModel.BackgroundAudioColumn3, Mode=OneWay}" 
                                             ItemTemplate="{StaticResource AppUsageItemTemplate}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <StackPanel Spacing="0"/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                </ItemsControl>
                            </ScrollViewer>
                            
                            <!-- Empty state -->
                            <TextBlock Grid.Row="1" Grid.ColumnSpan="3"
                                      l:Uids.Uid="Dashboard_NoAudio"
                                      Opacity="0.4" 
                                      HorizontalAlignment="Center" 
                                      VerticalAlignment="Center"
                                      FontSize="16"
                                      Visibility="{x:Bind IsBackgroundAudioEmpty(ViewModel.BackgroundAudioItems.Count), Mode=OneWay}"/>
                        </Grid>
                    </TabViewItem>

                    <!-- Tab 3: AFK Time -->
                    <TabViewItem l:Uids.Uid="Dashboard_TabAfkTime" IsClosable="False">
                        <Grid Padding="16">
                            <!-- Data Card -->
                            <Grid Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="8" Padding="20" VerticalAlignment="Top"
                                  Visibility="{x:Bind IsAfkVisible(ViewModel.AfkDuration, ViewModel.LockDuration), Mode=OneWay}">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                
                                <!-- AFK Row -->
                                <FontIcon Grid.Row="0" Grid.Column="0" Glyph="&#xE916;" Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}" FontSize="24" Margin="0,0,16,12"/>
                                <StackPanel Grid.Row="0" Grid.Column="1" Margin="0,0,0,12">
                                    <TextBlock l:Uids.Uid="Dashboard_AwayFromKeyboard" FontWeight="SemiBold" FontSize="16"/>
                                    <TextBlock Text="{x:Bind ViewModel.AfkDurationStr, Mode=OneWay}" Opacity="0.7" FontSize="14"/>
                                </StackPanel>
                                
                                <!-- Lock Row -->
                                <FontIcon Grid.Row="1" Grid.Column="0" Glyph="&#xE72E;" Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}" FontSize="24" Margin="0,0,16,0"/>
                                <StackPanel Grid.Row="1" Grid.Column="1">
                                    <TextBlock l:Uids.Uid="Dashboard_ScreenLocked" FontWeight="SemiBold" FontSize="16"/>
                                    <TextBlock Text="{x:Bind ViewModel.LockDurationStr, Mode=OneWay}" Opacity="0.7" FontSize="14"/>
                                </StackPanel>
                            </Grid>
                            
                            <!-- Empty State -->
                            <TextBlock l:Uids.Uid="Dashboard_NoData" Opacity="0.4" HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="16"
                                       Visibility="{x:Bind IsAfkEmpty(ViewModel.AfkDuration, ViewModel.LockDuration), Mode=OneWay}"/>
                        </Grid>
                    </TabViewItem>
                </TabView.TabItems>
            </TabView>
            
            <!-- Combined View -->
            <StackPanel x:Name="CombinedViewMode" Grid.Row="2" Margin="0,10,0,0" Spacing="30" Visibility="Collapsed">
                <StackPanel Spacing="10">
                    <TextBlock l:Uids.Uid="Dashboard_ActiveWindows" FontSize="20" FontWeight="SemiBold" Margin="0,0,0,10"/>
                    <Grid ColumnSpacing="10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/><ColumnDefinition Width="*"/><ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <ItemsControl Grid.Column="0" ItemsSource="{x:Bind ViewModel.Column1Items, Mode=OneWay}" ItemTemplate="{StaticResource AppUsageItemTemplate}"><ItemsControl.ItemsPanel><ItemsPanelTemplate><StackPanel Spacing="0"/></ItemsPanelTemplate></ItemsControl.ItemsPanel></ItemsControl>
                        <ItemsControl Grid.Column="1" ItemsSource="{x:Bind ViewModel.Column2Items, Mode=OneWay}" ItemTemplate="{StaticResource AppUsageItemTemplate}"><ItemsControl.ItemsPanel><ItemsPanelTemplate><StackPanel Spacing="0"/></ItemsPanelTemplate></ItemsControl.ItemsPanel></ItemsControl>
                        <ItemsControl Grid.Column="2" ItemsSource="{x:Bind ViewModel.Column3Items, Mode=OneWay}" ItemTemplate="{StaticResource AppUsageItemTemplate}"><ItemsControl.ItemsPanel><ItemsPanelTemplate><StackPanel Spacing="0"/></ItemsPanelTemplate></ItemsControl.ItemsPanel></ItemsControl>
                    </Grid>
                </StackPanel>
                <StackPanel Spacing="10">
                    <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,0,0,10">
                        <TextBlock l:Uids.Uid="Dashboard_BackgroundAudio" FontSize="20" FontWeight="SemiBold" VerticalAlignment="Center"/>
                        <TextBlock l:Uids.Uid="Dashboard_NotCounted" Opacity="0.5" FontSize="14" VerticalAlignment="Center"/>
                    </StackPanel>
                    <Grid ColumnSpacing="10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/><ColumnDefinition Width="*"/><ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <ItemsControl Grid.Column="0" ItemsSource="{x:Bind ViewModel.BackgroundAudioColumn1, Mode=OneWay}" ItemTemplate="{StaticResource AppUsageItemTemplate}"><ItemsControl.ItemsPanel><ItemsPanelTemplate><StackPanel Spacing="0"/></ItemsPanelTemplate></ItemsControl.ItemsPanel></ItemsControl>
                        <ItemsControl Grid.Column="1" ItemsSource="{x:Bind ViewModel.BackgroundAudioColumn2, Mode=OneWay}" ItemTemplate="{StaticResource AppUsageItemTemplate}"><ItemsControl.ItemsPanel><ItemsPanelTemplate><StackPanel Spacing="0"/></ItemsPanelTemplate></ItemsControl.ItemsPanel></ItemsControl>
                        <ItemsControl Grid.Column="2" ItemsSource="{x:Bind ViewModel.BackgroundAudioColumn3, Mode=OneWay}" ItemTemplate="{StaticResource AppUsageItemTemplate}"><ItemsControl.ItemsPanel><ItemsPanelTemplate><StackPanel Spacing="0"/></ItemsPanelTemplate></ItemsControl.ItemsPanel></ItemsControl>
                        <TextBlock Grid.ColumnSpan="3" l:Uids.Uid="Dashboard_NoAudio" Opacity="0.4" HorizontalAlignment="Center" Margin="0,40,0,0" FontSize="16" Visibility="{x:Bind IsBackgroundAudioEmpty(ViewModel.BackgroundAudioItems.Count), Mode=OneWay}"/>
                    </Grid>
                </StackPanel>
                
                <!-- AFK Time Section -->
                <StackPanel Spacing="10" Visibility="{x:Bind IsAfkVisible(ViewModel.AfkDuration, ViewModel.LockDuration), Mode=OneWay}">
                    <TextBlock l:Uids.Uid="Dashboard_AfkTimeTitle" FontSize="20" FontWeight="SemiBold" Margin="0,20,0,0"/>
                    <Grid Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="8" Padding="16">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        
                        <!-- AFK Row -->
                        <FontIcon Grid.Row="0" Grid.Column="0" Glyph="&#xE916;" Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}" Margin="0,0,12,8"/>
                        <StackPanel Grid.Row="0" Grid.Column="1" Orientation="Horizontal" Margin="0,0,0,8">
                            <TextBlock l:Uids.Uid="Dashboard_AwayFromKeyboard" FontWeight="SemiBold" VerticalAlignment="Center"/>
                            <TextBlock Text="{x:Bind ViewModel.AfkDurationStr, Mode=OneWay}" Margin="16,0,0,0" Opacity="0.7" VerticalAlignment="Center"/>
                        </StackPanel>
                        
                        <!-- Lock Row -->
                        <FontIcon Grid.Row="1" Grid.Column="0" Glyph="&#xE72E;" Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}" Margin="0,0,12,0"/>
                        <StackPanel Grid.Row="1" Grid.Column="1" Orientation="Horizontal">
                            <TextBlock l:Uids.Uid="Dashboard_ScreenLocked" FontWeight="SemiBold" VerticalAlignment="Center"/>
                            <TextBlock Text="{x:Bind ViewModel.LockDurationStr, Mode=OneWay}" Margin="16,0,0,0" Opacity="0.7" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Grid>
                </StackPanel>
            </StackPanel>
        </Grid>
    </ScrollViewer>
</Page>
