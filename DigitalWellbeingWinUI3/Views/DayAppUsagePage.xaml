<Page
    x:Class="DigitalWellbeingWinUI3.Views.DayAppUsagePage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d">

    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <Grid Padding="20">
            <!-- 
                 CRITICAL LAYOUT ARCHITECTURE:
                 1. Full Page Scroll: The root ScrollViewer handles scrolling for the entire page.
                 2. GridView Scrolling Disabled: The inner GridView must have VerticalScrollMode="Disabled" to avoid dual scrollbars and allow it to expand fully.
                 3. Chart Row vs List Row: By sharing the same ScrollViewer, both rows align perfectly in width.
            -->
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <StackPanel Grid.Row="0" Orientation="Horizontal" HorizontalAlignment="Left" Margin="0,0,0,20">
                <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="12" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" Padding="15,10">
                    <StackPanel Orientation="Horizontal">
                        <Button Background="Transparent" VerticalAlignment="Center" BorderThickness="0" Padding="0" Margin="0,0,10,0" ToolTipService.ToolTip="Select Date">
                            <TextBlock Text="ðŸ“…" VerticalAlignment="Center"/>
                            <Button.Flyout>
                                <Flyout x:Name="CalendarFlyout" Placement="Bottom">
                                    <CalendarView x:Name="CalendarPicker" SelectionMode="Single" SelectedDatesChanged="CalendarPicker_SelectedDatesChanged" />
                                </Flyout>
                            </Button.Flyout>
                        </Button>
                        <TextBlock Text="{x:Bind ViewModel.StrLoadedDate, Mode=OneWay}" Style="{ThemeResource TitleTextBlockStyle}" FontSize="18" VerticalAlignment="Center" Width="250" TextAlignment="Center"/>
                        <Button Content="&lt;" Command="{x:Null}" IsEnabled="{x:Bind ViewModel.CanGoPrev, Mode=OneWay}" Click="BtnPrev_Click" Background="Transparent" BorderThickness="0" Margin="10,0,0,0"/>
                        <Button Content="&gt;" Command="{x:Null}" IsEnabled="{x:Bind ViewModel.CanGoNext, Mode=OneWay}" Click="BtnNext_Click" Background="Transparent" BorderThickness="0"/>
                    </StackPanel>
                </Border>
                
                <!-- Total Duration Label + Trend -->
                <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="12" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" Padding="15,10" Margin="10,0,0,0" VerticalAlignment="Center">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="Total:" Opacity="0.6" VerticalAlignment="Center"/>
                        <TextBlock Text="{x:Bind ViewModel.StrTotalDuration, Mode=OneWay}" FontWeight="SemiBold" VerticalAlignment="Center"/>
                        
                        <!-- Trend Indicator -->
                        <StackPanel Orientation="Horizontal" Margin="12,0,0,0" VerticalAlignment="Center" ToolTipService.ToolTip="{x:Bind ViewModel.TrendDescription, Mode=OneWay}">
                            <TextBlock Text="{x:Bind ViewModel.TrendPercentage, Mode=OneWay}" FontWeight="Bold" Foreground="{x:Bind GetTrendBrush(ViewModel.TrendIsGood), Mode=OneWay}"/>
                            <TextBlock Text="{x:Bind ViewModel.TrendDescription, Mode=OneWay}" Opacity="0.6" Margin="6,0,0,0" FontSize="12" VerticalAlignment="Center"/>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </StackPanel>

            <!-- ROW 1: CHARTS (Side by Side) -->
            <Grid Grid.Row="1" Margin="0,0,0,20">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="2*"/>
                    <ColumnDefinition Width="1*"/>
                </Grid.ColumnDefinitions>

                <!-- Bar Chart -->
                <Border Grid.Column="0" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="12" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" Padding="15" Margin="0,0,10,0">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="250"/> 
                        </Grid.RowDefinitions>
                        <TextBlock Text="Daily Activity" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,10"/>
                        <ContentControl x:Name="BarChartContainer" Grid.Row="1" HorizontalContentAlignment="Stretch" VerticalContentAlignment="Stretch"/>
                    </Grid>
                </Border>

                <!-- Pie Chart -->
                <Border Grid.Column="1" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="12" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" Padding="15" Margin="10,0,0,0">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="250"/> 
                        </Grid.RowDefinitions>
                        <TextBlock Text="Usage Summary" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,10"/>
                        <ContentControl x:Name="PieChartContainer" Grid.Row="1" HorizontalContentAlignment="Stretch" VerticalContentAlignment="Stretch"/>
                    </Grid>
                </Border>
            </Grid>

            <!-- ROW 2: APP LIST (Was Row 3) -->
            <ItemsControl Grid.Row="2" x:Name="AppListGridView" ItemsSource="{x:Bind ViewModel.DayListItems, Mode=OneWay}" Margin="0,10,0,0">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <StackPanel Spacing="10"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Border CornerRadius="12" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" Padding="0">
                            <Border.ContextFlyout>
                                <MenuFlyout Opening="MenuFlyout_Opening">
                                    <MenuFlyoutItem Text="Set Time Limit" Icon="Clock" Click="MenuFlyoutItem_SetTimeLimit_Click" Tag="{Binding ProcessName}"/>
                                    <MenuFlyoutSubItem Text="Set Category" Icon="Tag">
                                    </MenuFlyoutSubItem>
                                    <MenuFlyoutSeparator/>
                                    <MenuFlyoutItem Text="Exclude App" Icon="Delete" Click="MenuFlyoutItem_ExcludeApp_Click" Tag="{Binding ProcessName}"/>
                                </MenuFlyout>
                            </Border.ContextFlyout>
                            
                            <StackPanel>
                                <Grid Height="60" Padding="15,0" RightTapped="Grid_RightTapped" Background="Transparent" ToolTipService.ToolTip="Click to expand details">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <Button HorizontalAlignment="Stretch" VerticalAlignment="Stretch" Opacity="0" Grid.ColumnSpan="4" Command="{Binding ToggleExpandCommand}"/>

                                    <Image Source="{Binding IconSource}" Width="32" Height="32" Margin="0,0,15,0" VerticalAlignment="Center" IsHitTestVisible="False"/>

                                    <StackPanel Grid.Column="1" VerticalAlignment="Center" IsHitTestVisible="False">
                                        <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                            <TextBlock Text="{Binding ProcessName}" FontWeight="SemiBold" FontSize="15" Margin="0,0,10,0"/>
                                            <Grid VerticalAlignment="Center" CornerRadius="8">
                                                <Border Background="{Binding BrushAppTagBg}" CornerRadius="8"/>
                                                <Border Padding="8,2" BorderBrush="{Binding BrushAppTag}" BorderThickness="0">
                                                    <TextBlock Text="{Binding StrAppTag}" Foreground="{Binding BrushAppTag}" FontSize="11" FontWeight="Bold"/>
                                                </Border>
                                            </Grid>
                                        </StackPanel>
                                        
                                        <ProgressBar Value="{Binding Percentage}" Maximum="100" Height="4" CornerRadius="2" HorizontalAlignment="Stretch" Margin="0,0,10,0"/>
                                    </StackPanel>

                                    <TextBlock Grid.Column="2" Text="{Binding StrDuration}" VerticalAlignment="Center" HorizontalAlignment="Right" FontWeight="SemiBold" FontSize="14" Margin="10,0,10,0" IsHitTestVisible="False"/>
                                    
                                    <FontIcon Grid.Column="3" Glyph="&#xE70D;" FontSize="12" Opacity="0.5" VerticalAlignment="Center" IsHitTestVisible="False">
                                        <FontIcon.RenderTransform>
                                            <RotateTransform Angle="{Binding ChevronRotation}" CenterX="6" CenterY="6"/>
                                        </FontIcon.RenderTransform>
                                    </FontIcon>
                                </Grid>

                                <ItemsControl ItemsSource="{Binding Children}" Visibility="{Binding IsExpanded, Converter={StaticResource BoolToVisibilityConverter}}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Grid Padding="60,8,15,8" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="0,1,0,0">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="100"/>
                                                    <ColumnDefinition Width="80"/>
                                                </Grid.ColumnDefinitions>
                                                
                                                <StackPanel Orientation="Horizontal" Spacing="10" VerticalAlignment="Center">
                                                     <FontIcon Glyph="&#xE774;" FontSize="12" Opacity="0.5"/> 
                                                     <TextBlock Text="{Binding Title}" FontSize="13" TextTrimming="CharacterEllipsis"/>
                                                </StackPanel>

                                                <ProgressBar Grid.Column="1" Value="{Binding Percentage}" Maximum="100" Height="3" CornerRadius="1.5" VerticalAlignment="Center" Opacity="0.6"/>
                                                
                                                <TextBlock Grid.Column="2" Text="{Binding StrDuration}" FontSize="12" Opacity="0.7" HorizontalAlignment="Right" VerticalAlignment="Center"/>
                                            </Grid>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </Grid>
    </ScrollViewer>
</Page>
