<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="DigitalWellbeingWinUI3.Views.SessionsPage"
    x:Name="RootPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:DigitalWellbeingWinUI3.Views"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Grid Grid.Row="0" Margin="24,24,24,10">
            <StackPanel Spacing="4">
                <TextBlock Text="Timeline" Style="{ThemeResource TitleTextBlockStyle}"/>
                <TextBlock Text="Visualize your day." Style="{ThemeResource BodyTextBlockStyle}" Opacity="0.6"/>
            </StackPanel>
        </Grid>

        <!-- Controls -->
        <!-- Controls -->
        <Grid Grid.Row="1" Margin="24,0,24,16" ColumnSpacing="12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            
            <!-- Date Navigation (Styled) -->
            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12">
                <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="8" Padding="10,5" Height="44" VerticalAlignment="Top">
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <Button Background="Transparent" BorderThickness="0" Padding="0" Margin="0,0,10,0" ToolTipService.ToolTip="Select Date">
                            <TextBlock Text="ðŸ“…" VerticalAlignment="Center"/>
                            <Button.Flyout>
                                <Flyout x:Name="CalendarFlyout" Placement="Bottom">
                                    <CalendarView x:Name="CalendarPicker" SelectionMode="Single" SelectedDatesChanged="CalendarPicker_SelectedDatesChanged" />
                                </Flyout>
                            </Button.Flyout>
                        </Button>
                        <TextBlock Text="{x:Bind ViewModel.SelectedDate, Converter={StaticResource DateFormatConverter}, Mode=OneWay}" 
                                   Style="{ThemeResource TitleTextBlockStyle}" FontSize="18" VerticalAlignment="Center" 
                                   Width="200" TextAlignment="Center" TextTrimming="CharacterEllipsis"/>
                        
                        <Button Content="&lt;" Command="{x:Bind ViewModel.PreviousDayCommand}" Background="Transparent" BorderThickness="0" Margin="10,0,0,0"/>
                        <Button Content="&gt;" Command="{x:Bind ViewModel.NextDayCommand}" IsEnabled="{x:Bind ViewModel.CanGoNext, Mode=OneWay}" Background="Transparent" BorderThickness="0"/>
                    </StackPanel>
                </Border>
                <Button Content="Today" Command="{x:Bind ViewModel.TodayCommand}" VerticalAlignment="Center"/>
            </StackPanel>

            <!-- Zoom Controls -->
            <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="16">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <Button Command="{x:Bind ViewModel.ZoomOutCommand}" Content="Zoom Out"/>
                    <Button Command="{x:Bind ViewModel.ZoomInCommand}" Content="Zoom In"/>
                </StackPanel>
            </StackPanel>
        </Grid>

        <!-- Timeline Body -->
        <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto">
            <Grid x:Name="ContainerGrid" Margin="24,0,24,24" SizeChanged="ContainerGrid_SizeChanged">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="60"/> <!-- Labels -->
                    <ColumnDefinition Width="*"/>  <!-- Canvas -->
                </Grid.ColumnDefinitions>

                <!-- Grid Lines & Labels -->
                <ItemsControl Grid.ColumnSpan="2" ItemsSource="{x:Bind ViewModel.GridLines, Mode=OneWay}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <Canvas />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Grid Width="{Binding Width}"> <!-- Width to span across -->
                                <Grid.RenderTransform>
                                    <TranslateTransform Y="{Binding Top}"/>
                                </Grid.RenderTransform>
                                
                                <Border BorderBrush="{ThemeResource SystemControlForegroundBaseLowBrush}" BorderThickness="0,1,0,0" Opacity="{Binding Opacity}" Margin="60,0,0,0" Height="1" VerticalAlignment="Top"/>
                                <TextBlock Text="{Binding TimeText}" VerticalAlignment="Top" HorizontalAlignment="Right" Margin="0,-10,10,0" Opacity="0.5" FontSize="{Binding FontSize}"/>
                            </Grid>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

                <!-- Sessions -->
                <!-- 24h * 60px = 1440px Height -->
                <Canvas Grid.Column="0" Grid.ColumnSpan="2" Height="{x:Bind ViewModel.CanvasHeight, Mode=OneWay}" VerticalAlignment="Top">
                    <ItemsControl ItemsSource="{x:Bind ViewModel.SessionBlocks, Mode=OneWay}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <Canvas />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <!-- ItemContainerStyle removed, using RenderTransform in Template instead -->
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Grid Height="{Binding Height}" Width="{Binding Width}" ToolTipService.ToolTip="{Binding Title}">
                                    <Grid.RenderTransform>
                                        <TranslateTransform X="{Binding Left}" Y="{Binding Top}" />
                                    </Grid.RenderTransform>
                                    
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="4"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <!-- Indicator Bar -->
                                    <Rectangle Grid.Column="0" Fill="{Binding BackgroundColor}" RadiusX="2" RadiusY="2"/>
                                    
                                    <!-- Content -->
                                    <Border Grid.Column="1" Background="{Binding BackgroundColor}" Opacity="0.2" CornerRadius="0,4,4,0"/>
                                    <StackPanel Grid.Column="1" Padding="8,2" VerticalAlignment="Center">
                                        <TextBlock Text="{Binding Title}" FontSize="12" FontWeight="SemiBold" TextTrimming="CharacterEllipsis"/>
                                        <StackPanel Orientation="Horizontal" Spacing="4">
                                            <TextBlock Text="{Binding DurationText}" FontSize="10" Opacity="0.7"/>
                                            <Border Background="{ThemeResource SystemFillColorCautionBrush}" CornerRadius="2" Padding="2,0" Visibility="{Binding IsAfk}">
                                                <TextBlock Text="AFK" FontSize="8" Foreground="Black"/>
                                            </Border>
                                        </StackPanel>
                                    </StackPanel>
                                </Grid>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                    
                    <!-- Current Time Indicator -->
                    <Grid Width="{x:Bind ViewModel.TimelineWidth, Mode=OneWay}" Height="2" Canvas.Left="0" Canvas.Top="{x:Bind ViewModel.CurrentTimeTop, Mode=OneWay}" Visibility="{x:Bind ViewModel.CurrentTimeVisibility, Mode=OneWay}">
                        <Rectangle Fill="#FF5252" />
                        <Ellipse Width="8" Height="8" Fill="#FF5252" HorizontalAlignment="Left" Margin="-4,0,0,0" VerticalAlignment="Center"/>
                    </Grid>
                </Canvas>

            </Grid>
        </ScrollViewer>
    </Grid>
    
    <Page.Resources>
        <!-- Simple Date Converter -->
        <local:DateFormatConverter x:Key="DateFormatConverter"/>
    </Page.Resources>
</Page>
