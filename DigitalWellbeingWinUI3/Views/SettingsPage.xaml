<Page
    x:Class="DigitalWellbeingWinUI3.Views.SettingsPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:helpers="using:DigitalWellbeingWinUI3.Helpers"
    xmlns:models="using:DigitalWellbeingWinUI3.Models"
    mc:Ignorable="d">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Unsaved Changes Banner -->
        <Grid x:Name="UnsavedChangesBanner" Grid.Row="0" Background="{ThemeResource AccentFillColorDefaultBrush}" Visibility="Collapsed" Padding="20,12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <TextBlock Text="You have unsaved changes." VerticalAlignment="Center" Foreground="White" FontWeight="SemiBold"/>
            <Button Grid.Column="1" Content="Apply Changes" Click="ApplyAll_Click" Background="White" Foreground="Black" BorderThickness="0"/>
        </Grid>

        <ScrollViewer Grid.Row="1" Padding="20">
        <StackPanel Spacing="10" MaxWidth="800" HorizontalAlignment="Left">
            
            <TextBlock Text="Settings" Style="{ThemeResource TitleTextBlockStyle}" Margin="0,0,0,10"/>

            <!-- App Runtime -->
            <TextBlock Text="App Runtime" Style="{ThemeResource SubtitleTextBlockStyle}" Margin="0,10,0,5"/>
            <StackPanel Spacing="5">
                <!-- Run on Startup -->
                <Grid Padding="12" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <StackPanel Grid.Column="0" Spacing="2">
                        <TextBlock Text="Run on Startup" Style="{ThemeResource BodyStrongTextBlockStyle}"/>
                        <TextBlock Text="Runs this app on startup." Style="{ThemeResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                    </StackPanel>
                    <ToggleSwitch x:Name="EnableRunOnStartup" Grid.Column="1" Toggled="EnableRunOnStartup_Toggled"/>
                </Grid>

                <!-- Minimize on Exit -->
                <Grid Padding="12" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <StackPanel Grid.Column="0" Spacing="2">
                        <TextBlock Text="Minimize On Exit" Style="{ThemeResource BodyStrongTextBlockStyle}"/>
                        <TextBlock Text="Minimize the app to tray on exit instead of closing." Style="{ThemeResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                    </StackPanel>
                    <ToggleSwitch x:Name="ToggleMinimizeOnExit" Grid.Column="1" Toggled="ToggleMinimizeOnExit_Toggled"/>
                </Grid>
            </StackPanel>

            <!-- Usage Data -->
            <TextBlock Text="Usage Data" Style="{ThemeResource SubtitleTextBlockStyle}" Margin="0,10,0,5"/>

            <!-- Incognito Mode -->
            <Grid Padding="12" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="12">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <StackPanel Grid.Column="0" Spacing="2">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE72E;" FontFamily="Segoe MDL2 Assets" FontSize="16"/>
                        <TextBlock Text="Incognito Mode" Style="{ThemeResource BodyStrongTextBlockStyle}"/>
                    </StackPanel>
                    <TextBlock Text="Do not record window titles (e.g. YouTube video names)." Style="{ThemeResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                </StackPanel>
                <ToggleSwitch x:Name="ToggleIncognitoMode" Grid.Column="1" Toggled="ToggleIncognitoMode_Toggled"/>
            </Grid>
            
            <!-- Excluded Apps -->
            <Grid Padding="12" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="12">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <StackPanel Grid.Row="0" Spacing="2" Margin="0,0,0,10">
                    <TextBlock Text="Excluded Apps" Style="{ThemeResource BodyStrongTextBlockStyle}"/>
                    <TextBlock Text="Double-click to remove an excluded app." Style="{ThemeResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                </StackPanel>
                <ListView Grid.Row="1" x:Name="ExcludedAppList" Height="150" DoubleTapped="ExcludedAppList_DoubleTapped" BorderThickness="1" BorderBrush="{ThemeResource SurfaceStrokeColorDefaultBrush}" CornerRadius="4"/>
            </Grid>

            <!-- Time Limits -->
            <Grid Padding="12" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="12">
                 <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <StackPanel Grid.Row="0" Spacing="2" Margin="0,0,0,10">
                    <TextBlock Text="Time Limits per App" Style="{ThemeResource BodyStrongTextBlockStyle}"/>
                    <TextBlock Text="Double-click to remove time limit." Style="{ThemeResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                </StackPanel>
                <ListView Grid.Row="1" x:Name="AppTimeLimitsList" Height="150" DoubleTapped="AppTimeLimitsList_DoubleTapped" BorderThickness="1" BorderBrush="{ThemeResource SurfaceStrokeColorDefaultBrush}" CornerRadius="4"/>
            </Grid>

            <!-- Display -->
            <TextBlock Text="Display" Style="{ThemeResource SubtitleTextBlockStyle}" Margin="0,10,0,5"/>
             <StackPanel Spacing="5">
                <!-- Days to Show -->
                 <Grid Padding="12" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="12">
                     <Grid.ColumnDefinitions>
                         <ColumnDefinition Width="*"/>
                         <ColumnDefinition Width="Auto"/>
                     </Grid.ColumnDefinitions>
                     <StackPanel Grid.Column="0" Spacing="2">
                         <TextBlock Text="Days to show on graph" Style="{ThemeResource BodyStrongTextBlockStyle}"/>
                          <TextBlock Text="Number of days shown in the Dashboard weekly bar chart." Style="{ThemeResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                     </StackPanel>
                      <StackPanel Orientation="Horizontal" Grid.Column="1" Spacing="10">
                          <NumberBox x:Name="DaysToShowTextBox" Value="7" SpinButtonPlacementMode="Compact" Width="150" Minimum="1" ValueChanged="Settings_ValueChanged" KeyUp="Settings_KeyUp"/>
                      </StackPanel>
                 </Grid>

                 <!-- Days to Show on Detailed Usage -->
                 <Grid Padding="12" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="12">
                     <Grid.ColumnDefinitions>
                         <ColumnDefinition Width="*"/>
                         <ColumnDefinition Width="Auto"/>
                     </Grid.ColumnDefinitions>
                     <StackPanel Grid.Column="0" Spacing="2">
                         <TextBlock Text="Days to show on Detailed usage" Style="{ThemeResource BodyStrongTextBlockStyle}"/>
                         <TextBlock Text="Number of timeline columns in the Detailed Usage page (1-7 days)." Style="{ThemeResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                     </StackPanel>
                     <StackPanel Orientation="Horizontal" Grid.Column="1" Spacing="10">
                         <NumberBox x:Name="DetailedDaysTextBox" Value="1" SpinButtonPlacementMode="Compact" Width="150" Minimum="1" Maximum="7" ValueChanged="Settings_ValueChanged" KeyUp="Settings_KeyUp"/>
                     </StackPanel>
                 </Grid>

                 <!-- Minimum Duration -->
                <Grid Padding="12" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <StackPanel Grid.Column="0" Spacing="2">
                        <TextBlock Text="Minimum App Duration (seconds)" Style="{ThemeResource BodyStrongTextBlockStyle}"/>
                        <TextBlock Text="Apps with usage less than this will be hidden (default 0s)." Style="{ThemeResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Grid.Column="1" Spacing="10">
                        <NumberBox x:Name="MinDurationTextBox" Value="0" SpinButtonPlacementMode="Compact" Width="150" Minimum="0" ValueChanged="Settings_ValueChanged" KeyUp="Settings_KeyUp"/>
                    </StackPanel>
                </Grid>

                <!-- Refresh Interval -->
                <Grid Padding="12" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <StackPanel Grid.Column="0" Spacing="2">
                        <TextBlock Text="Auto-Refresh Interval (s)" Style="{ThemeResource BodyStrongTextBlockStyle}"/>
                         <TextBlock Text="Minimum 6 seconds." Style="{ThemeResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                    </StackPanel>
                     <StackPanel Orientation="Horizontal" Grid.Column="1" Spacing="10">
                         <ToggleSwitch x:Name="EnableAutoRefresh" Toggled="EnableAutoRefresh_Toggled"/>
                         <NumberBox x:Name="RefreshInterval" Width="150" SpinButtonPlacementMode="Compact" Minimum="6" Maximum="600" ValueChanged="RefreshInterval_ValueChanged" IsEnabled="{x:Bind EnableAutoRefresh.IsOn, Mode=OneWay}" KeyUp="Settings_KeyUp"/>
                     </StackPanel>
                </Grid>

                <!-- Timeline Merge Threshold -->
                <Grid Padding="12" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="12">
                     <Grid.ColumnDefinitions>
                         <ColumnDefinition Width="*"/>
                         <ColumnDefinition Width="Auto"/>
                     </Grid.ColumnDefinitions>
                     <StackPanel Grid.Column="0" Spacing="2">
                         <TextBlock Text="Timeline Detail Level (Merge Threshold s)" Style="{ThemeResource BodyStrongTextBlockStyle}"/>
                         <TextBlock Text="Lower values show more items but may reduce performance (Default 30s)." Style="{ThemeResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                     </StackPanel>
                     <StackPanel Orientation="Horizontal" Grid.Column="1" Spacing="10">
                         <NumberBox x:Name="TimelineThresholdTextBox" Value="30" SpinButtonPlacementMode="Compact" Width="150" Minimum="0" Maximum="300" ValueChanged="Settings_ValueChanged" KeyUp="Settings_KeyUp"/>
                     </StackPanel>
                 </Grid>

                 <!-- Theme Mode -->
                <Grid Padding="12" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <StackPanel Grid.Column="0" Spacing="2">
                        <TextBlock Text="Theme Mode" Style="{ThemeResource BodyStrongTextBlockStyle}"/>
                    </StackPanel>
                    <ComboBox x:Name="CBTheme" Grid.Column="1" SelectionChanged="CBTheme_SelectionChanged" Width="150">
                        <ComboBoxItem Content="System" Tag="System"/>
                        <ComboBoxItem Content="Light" Tag="Light"/>
                        <ComboBoxItem Content="Dark" Tag="Dark"/>
                    </ComboBox>
                </Grid>
                
                <!-- Combined Audio View -->
                <Grid Padding="12" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <StackPanel Grid.Column="0" Spacing="2">
                        <TextBlock Text="Combined Audio View" Style="{ThemeResource BodyStrongTextBlockStyle}"/>
                        <TextBlock Text="Show Active Windows and Background Audio on same page instead of tabs." Style="{ThemeResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                    </StackPanel>
                    <ToggleSwitch x:Name="ToggleCombinedAudioView" Grid.Column="1" Toggled="ToggleCombinedAudioView_Toggled"/>
                </Grid>
             </StackPanel>

            <!-- Data -->
             <TextBlock Text="Data" Style="{ThemeResource SubtitleTextBlockStyle}" Margin="0,10,0,5"/>
             <Grid Padding="12" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="12">
                 <Grid.RowDefinitions>
                     <RowDefinition Height="Auto"/>
                     <RowDefinition Height="Auto"/>
                 </Grid.RowDefinitions>
                 
                 <!-- Log Storage Location -->
                 <StackPanel Grid.Row="0" Spacing="5" Margin="0,0,0,10">
                     <TextBlock Text="Log Storage Location" Style="{ThemeResource BodyStrongTextBlockStyle}"/>
                     <TextBlock Text="Change where usage logs are stored. Service will restart when changed." Style="{ThemeResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                     <Grid Margin="0,5,0,0">
                         <Grid.ColumnDefinitions>
                             <ColumnDefinition Width="*"/>
                             <ColumnDefinition Width="Auto"/>
                             <ColumnDefinition Width="Auto"/>
                             <ColumnDefinition Width="Auto"/>
                         </Grid.ColumnDefinitions>
                         <TextBox x:Name="TxtLogLocation" Grid.Column="0" PlaceholderText="Default Location" Margin="0,0,10,0" MaxWidth="400" HorizontalAlignment="Left" TextWrapping="NoWrap" AcceptsReturn="False" TextChanged="TxtLogLocation_TextChanged"/>
                         <Button Grid.Column="1" Content="Open" Click="BtnOpenAppFolder_Click" Margin="0,0,5,0"/>
                         <Button Grid.Column="2" Content="Browse..." Click="BtnBrowseLogLocation_Click" Margin="0,0,5,0"/>
                         <Button Grid.Column="3" Content="Reset" Click="BtnResetLogLocation_Click"/>
                     </Grid>
                 </StackPanel>

                 <!-- Data Flush Interval -->
                 <StackPanel Grid.Row="1" Spacing="5">
                     <TextBlock Text="Data Flush Interval (seconds)" Style="{ThemeResource BodyStrongTextBlockStyle}"/>
                     <TextBlock Text="How often usage data in RAM is saved to disk. Lower values = more disk writes but better recovery on crash (Default 300s = 5 min)." Style="{ThemeResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}" TextWrapping="Wrap"/>
                     <NumberBox x:Name="DataFlushIntervalTextBox" Value="300" SpinButtonPlacementMode="Compact" Width="150" Minimum="60" Maximum="1800" HorizontalAlignment="Left" ValueChanged="Settings_ValueChanged" KeyUp="Settings_KeyUp"/>
                 </StackPanel>
              </Grid>

             <!-- App Tags -->
             <TextBlock Text="App Tags" Style="{ThemeResource SubtitleTextBlockStyle}" Margin="0,10,0,5"/>
             <Grid Padding="12" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="12">
                 <Grid.RowDefinitions>
                     <RowDefinition Height="Auto"/>
                     <RowDefinition Height="*"/>
                     <RowDefinition Height="Auto"/>
                 </Grid.RowDefinitions>
                 
                 <TextBlock Text="Manage Categories and Colors" Style="{ThemeResource BodyStrongTextBlockStyle}" Margin="0,0,0,10"/>

                 <ListView Grid.Row="1" ItemsSource="{x:Bind Tags}" SelectionMode="None">
                     <ListView.ItemTemplate>
                         <DataTemplate x:DataType="models:CustomAppTag">
                             <Grid Margin="0,4">
                                 <Grid.ColumnDefinitions>
                                     <ColumnDefinition Width="Auto"/> <!-- Color -->
                                     <ColumnDefinition Width="*"/>    <!-- Name -->
                                     <ColumnDefinition Width="Auto"/> <!-- Delete -->
                                 </Grid.ColumnDefinitions>
                                 
                                 <Button Grid.Column="0" Width="32" Height="32" CornerRadius="16" Margin="0,0,12,0" Padding="0"
                                         Background="{x:Bind helpers:AppTagHelper.GetBrush(HexColor), Mode=OneWay}">
                                     <Button.Flyout>
                                         <Flyout Closed="ColorPickerFlyout_Closed">
                                             <ColorPicker ColorSpectrumShape="Ring" IsMoreButtonVisible="True" IsColorSliderVisible="True" IsColorChannelTextInputVisible="False" 
                                                          ColorChanged="ColorPicker_ColorChanged" Tag="{x:Bind Id}"/>
                                         </Flyout>
                                     </Button.Flyout>
                                 </Button>
                                 
                                 <TextBox Grid.Column="1" Text="{x:Bind Name, Mode=TwoWay}" LostFocus="TagName_LostFocus" VerticalAlignment="Center"/>
                                 
                                 <Button Grid.Column="2" Content="&#xE74D;" FontFamily="Segoe MDL2 Assets" Click="BtnDeleteTag_Click" Tag="{x:Bind Id}" Margin="10,0,0,0" Background="Transparent"/>
                             </Grid>
                         </DataTemplate>
                     </ListView.ItemTemplate>
                 </ListView>
                 
                 <Button Grid.Row="2" Content="Add Tag" Click="BtnAddTag_Click" Margin="0,10,0,0"/>
             </Grid>


             <!-- About -->
             <TextBlock Text="About" Style="{ThemeResource SubtitleTextBlockStyle}" Margin="0,10,0,5"/>
             <StackPanel Spacing="5">
                  <TextBlock x:Name="TxtCurrentVersion" Text="App Version: ..." Style="{ThemeResource BodyTextBlockStyle}"/>
                  <TextBlock Text="Created by David Cepero" Style="{ThemeResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                  <TextBlock Text="Copyright Â© 2025. All rights reserved." Style="{ThemeResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                  <HyperlinkButton Content="Source Code (GitHub)" NavigateUri="https://github.com/Some1sm/Windows-Digital-Wellbeing"/>
             </StackPanel>

        </StackPanel>
        </ScrollViewer>
    </Grid>
</Page>
