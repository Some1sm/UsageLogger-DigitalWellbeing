<Page
    x:Class="DigitalWellbeingWinUI3.Views.SettingsPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:helpers="using:DigitalWellbeingWinUI3.Helpers"
    xmlns:models="using:DigitalWellbeingWinUI3.Models"
    mc:Ignorable="d">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Unsaved Changes Banner -->
        <Grid x:Name="UnsavedChangesBanner" Grid.Row="0" Background="{ThemeResource AccentFillColorDefaultBrush}" Visibility="Collapsed" Padding="20,12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <TextBlock x:Uid="Settings_UnsavedChanges" Foreground="White" FontWeight="SemiBold"/>
            <Button Grid.Column="1" x:Uid="Settings_ApplyChanges" Click="ApplyAll_Click" Background="White" Foreground="Black" BorderThickness="0"/>
        </Grid>

        <ScrollViewer Grid.Row="1" Padding="20">
        <StackPanel Spacing="10" MaxWidth="800" HorizontalAlignment="Left">
            
            <TextBlock x:Uid="Settings_Title" Style="{ThemeResource TitleTextBlockStyle}" Margin="0,0,0,10"/>

            <!-- App Runtime -->
            <TextBlock x:Uid="Settings_AppRuntime" Style="{ThemeResource SubtitleTextBlockStyle}" Margin="0,10,0,5"/>
            <StackPanel Spacing="5">
                <!-- Run on Startup -->
                <Grid Padding="12" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <StackPanel Grid.Column="0" Spacing="2">
                        <TextBlock x:Uid="Settings_RunOnStartup" Style="{ThemeResource BodyStrongTextBlockStyle}"/>
                        <TextBlock x:Uid="Settings_RunOnStartupDesc" Style="{ThemeResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                    </StackPanel>
                    <ToggleSwitch x:Name="EnableRunOnStartup" Grid.Column="1" Toggled="EnableRunOnStartup_Toggled"/>
                </Grid>

                <!-- Minimize on Exit -->
                <Grid Padding="12" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <StackPanel Grid.Column="0" Spacing="2">
                        <TextBlock x:Uid="Settings_MinimizeOnExit" Style="{ThemeResource BodyStrongTextBlockStyle}"/>
                        <TextBlock x:Uid="Settings_MinimizeOnExitDesc" Style="{ThemeResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                    </StackPanel>
                    <ToggleSwitch x:Name="ToggleMinimizeOnExit" Grid.Column="1" Toggled="ToggleMinimizeOnExit_Toggled"/>
                </Grid>
            </StackPanel>

            <!-- Usage Data -->
            <TextBlock x:Uid="Settings_UsageData" Style="{ThemeResource SubtitleTextBlockStyle}" Margin="0,10,0,5"/>

            <!-- Incognito Mode -->
            <Grid Padding="12" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="12">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <StackPanel Grid.Column="0" Spacing="2">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE72E;" FontFamily="Segoe MDL2 Assets" FontSize="16"/>
                        <TextBlock x:Uid="Settings_IncognitoMode" Style="{ThemeResource BodyStrongTextBlockStyle}"/>
                    </StackPanel>
                    <TextBlock x:Uid="Settings_IncognitoModeDesc" Style="{ThemeResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                </StackPanel>
                <ToggleSwitch x:Name="ToggleIncognitoMode" Grid.Column="1" Toggled="ToggleIncognitoMode_Toggled"/>
            </Grid>
            
            <!-- Excluded Apps -->
            <Grid Padding="12" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="12">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <StackPanel Grid.Row="0" Spacing="2" Margin="0,0,0,10">
                    <TextBlock x:Uid="Settings_ExcludedApps" Style="{ThemeResource BodyStrongTextBlockStyle}"/>
                    <TextBlock x:Uid="Settings_ExcludedAppsDesc" Style="{ThemeResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                </StackPanel>
                <ListView Grid.Row="1" x:Name="ExcludedAppList" Height="150" DoubleTapped="ExcludedAppList_DoubleTapped" BorderThickness="1" BorderBrush="{ThemeResource SurfaceStrokeColorDefaultBrush}" CornerRadius="4"/>
            </Grid>

            <!-- Time Limits -->
            <Grid Padding="12" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="12">
                 <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <StackPanel Grid.Row="0" Spacing="2" Margin="0,0,0,10">
                    <TextBlock x:Uid="Settings_TimeLimits" Style="{ThemeResource BodyStrongTextBlockStyle}"/>
                    <TextBlock x:Uid="Settings_TimeLimitsDesc" Style="{ThemeResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                </StackPanel>
                <ListView Grid.Row="1" x:Name="AppTimeLimitsList" Height="150" DoubleTapped="AppTimeLimitsList_DoubleTapped" BorderThickness="1" BorderBrush="{ThemeResource SurfaceStrokeColorDefaultBrush}" CornerRadius="4"/>
            </Grid>

            <!-- Display -->
            <TextBlock x:Uid="Settings_Display" Style="{ThemeResource SubtitleTextBlockStyle}" Margin="0,10,0,5"/>
             <StackPanel Spacing="5">
                <!-- Days to Show -->
                 <Grid Padding="12" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="12">
                     <Grid.ColumnDefinitions>
                         <ColumnDefinition Width="*"/>
                         <ColumnDefinition Width="Auto"/>
                     </Grid.ColumnDefinitions>
                     <StackPanel Grid.Column="0" Spacing="2">
                         <TextBlock x:Uid="Settings_DaysToShow" Style="{ThemeResource BodyStrongTextBlockStyle}"/>
                          <TextBlock x:Uid="Settings_DaysToShowDesc" Style="{ThemeResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                     </StackPanel>
                      <StackPanel Orientation="Horizontal" Grid.Column="1" Spacing="10">
                          <NumberBox x:Name="DaysToShowTextBox" Value="7" SpinButtonPlacementMode="Compact" Width="150" Minimum="1" ValueChanged="Settings_ValueChanged" KeyUp="Settings_KeyUp"/>
                      </StackPanel>
                 </Grid>

                 <!-- Days to Show on Detailed Usage -->
                 <Grid Padding="12" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="12">
                     <Grid.ColumnDefinitions>
                         <ColumnDefinition Width="*"/>
                         <ColumnDefinition Width="Auto"/>
                     </Grid.ColumnDefinitions>
                     <StackPanel Grid.Column="0" Spacing="2">
                          <TextBlock x:Uid="Settings_DetailedDays" Style="{ThemeResource BodyStrongTextBlockStyle}"/>
                          <TextBlock x:Uid="Settings_DetailedDaysDesc" Style="{ThemeResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                     </StackPanel>
                     <StackPanel Orientation="Horizontal" Grid.Column="1" Spacing="10">
                         <NumberBox x:Name="DetailedDaysTextBox" Value="1" SpinButtonPlacementMode="Compact" Width="150" Minimum="1" Maximum="7" ValueChanged="Settings_ValueChanged" KeyUp="Settings_KeyUp"/>
                     </StackPanel>
                 </Grid>

                 <!-- Minimum Duration -->
                <Grid Padding="12" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <StackPanel Grid.Column="0" Spacing="2">
                        <TextBlock x:Uid="Settings_MinDuration" Style="{ThemeResource BodyStrongTextBlockStyle}"/>
                        <TextBlock x:Uid="Settings_MinDurationDesc" Style="{ThemeResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Grid.Column="1" Spacing="10">
                        <NumberBox x:Name="MinDurationTextBox" Value="0" SpinButtonPlacementMode="Compact" Width="150" Minimum="0" ValueChanged="Settings_ValueChanged" KeyUp="Settings_KeyUp"/>
                    </StackPanel>
                </Grid>

                <!-- Refresh Interval -->
                <Grid Padding="12" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <StackPanel Grid.Column="0" Spacing="2">
                        <TextBlock x:Uid="Settings_AutoRefresh" Style="{ThemeResource BodyStrongTextBlockStyle}"/>
                         <TextBlock x:Uid="Settings_AutoRefreshDesc" Style="{ThemeResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                    </StackPanel>
                     <StackPanel Orientation="Horizontal" Grid.Column="1" Spacing="10">
                         <ToggleSwitch x:Name="EnableAutoRefresh" Toggled="EnableAutoRefresh_Toggled"/>
                         <NumberBox x:Name="RefreshInterval" Width="150" SpinButtonPlacementMode="Compact" Minimum="6" Maximum="600" ValueChanged="RefreshInterval_ValueChanged" IsEnabled="{x:Bind EnableAutoRefresh.IsOn, Mode=OneWay}" KeyUp="Settings_KeyUp"/>
                     </StackPanel>
                </Grid>

                <!-- Timeline Merge Threshold -->
                <Grid Padding="12" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="12">
                     <Grid.ColumnDefinitions>
                         <ColumnDefinition Width="*"/>
                         <ColumnDefinition Width="Auto"/>
                     </Grid.ColumnDefinitions>
                     <StackPanel Grid.Column="0" Spacing="2">
                          <TextBlock x:Uid="Settings_TimelineThreshold" Style="{ThemeResource BodyStrongTextBlockStyle}"/>
                          <TextBlock x:Uid="Settings_TimelineThresholdDesc" Style="{ThemeResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                     </StackPanel>
                     <StackPanel Orientation="Horizontal" Grid.Column="1" Spacing="10">
                         <NumberBox x:Name="TimelineThresholdTextBox" Value="30" SpinButtonPlacementMode="Compact" Width="150" Minimum="0" Maximum="300" ValueChanged="Settings_ValueChanged" KeyUp="Settings_KeyUp"/>
                     </StackPanel>
                 </Grid>

                 <!-- Theme Mode -->
                <Grid Padding="12" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <StackPanel Grid.Column="0" Spacing="2">
                        <TextBlock x:Uid="Settings_ThemeMode" Style="{ThemeResource BodyStrongTextBlockStyle}"/>
                    </StackPanel>
                    <ComboBox x:Name="CBTheme" Grid.Column="1" SelectionChanged="CBTheme_SelectionChanged" Width="150">
                        <ComboBoxItem x:Uid="Settings_ThemeSystem" Tag="System"/>
                        <ComboBoxItem x:Uid="Settings_ThemeLight" Tag="Light"/>
                        <ComboBoxItem x:Uid="Settings_ThemeDark" Tag="Dark"/>
                    </ComboBox>
                </Grid>
                
                <!-- Combined Audio View -->
                <Grid Padding="12" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <StackPanel Grid.Column="0" Spacing="2">
                        <TextBlock x:Uid="Settings_CombinedAudio" Style="{ThemeResource BodyStrongTextBlockStyle}"/>
                        <TextBlock x:Uid="Settings_CombinedAudioDesc" Style="{ThemeResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                    </StackPanel>
                    <ToggleSwitch x:Name="ToggleCombinedAudioView" Grid.Column="1" Toggled="ToggleCombinedAudioView_Toggled"/>
                </Grid>
             </StackPanel>

            <!-- Data -->
             <TextBlock x:Uid="Settings_Data" Style="{ThemeResource SubtitleTextBlockStyle}" Margin="0,10,0,5"/>
             <Grid Padding="12" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="12">
                 <Grid.RowDefinitions>
                     <RowDefinition Height="Auto"/>
                     <RowDefinition Height="Auto"/>
                 </Grid.RowDefinitions>
                 
                 <!-- Log Storage Location -->
                 <StackPanel Grid.Row="0" Spacing="5" Margin="0,0,0,10">
                      <TextBlock x:Uid="Settings_LogStorage" Style="{ThemeResource BodyStrongTextBlockStyle}"/>
                      <TextBlock x:Uid="Settings_LogStorageDesc" Style="{ThemeResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                     <Grid Margin="0,5,0,0">
                         <Grid.ColumnDefinitions>
                             <ColumnDefinition Width="*"/>
                             <ColumnDefinition Width="Auto"/>
                             <ColumnDefinition Width="Auto"/>
                             <ColumnDefinition Width="Auto"/>
                         </Grid.ColumnDefinitions>
                         <TextBox x:Name="TxtLogLocation" Grid.Column="0" PlaceholderText="Default Location" Margin="0,0,10,0" MaxWidth="400" HorizontalAlignment="Left" TextWrapping="NoWrap" AcceptsReturn="False" TextChanged="TxtLogLocation_TextChanged"/>
                          <Button Grid.Column="1" x:Uid="Settings_BtnOpen" Click="BtnOpenAppFolder_Click" Margin="0,0,5,0"/>
                          <Button Grid.Column="2" x:Uid="Settings_BtnBrowse" Click="BtnBrowseLogLocation_Click" Margin="0,0,5,0"/>
                          <Button Grid.Column="3" x:Uid="Settings_BtnReset" Click="BtnResetLogLocation_Click"/>
                     </Grid>
                 </StackPanel>

                 <!-- Data Flush Interval -->
                  <StackPanel Grid.Row="1" Spacing="5">
                      <TextBlock x:Uid="Settings_DataFlush" Style="{ThemeResource BodyStrongTextBlockStyle}"/>
                      <TextBlock x:Uid="Settings_DataFlushDesc" Style="{ThemeResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}" TextWrapping="Wrap"/>
                     <NumberBox x:Name="DataFlushIntervalTextBox" Value="300" SpinButtonPlacementMode="Compact" Width="150" Minimum="60" Maximum="1800" HorizontalAlignment="Left" ValueChanged="Settings_ValueChanged" KeyUp="Settings_KeyUp"/>
                 </StackPanel>
              </Grid>

             <!-- App Tags -->
             <TextBlock x:Uid="Settings_AppTags" Style="{ThemeResource SubtitleTextBlockStyle}" Margin="0,10,0,5"/>
             <Grid Padding="12" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="12">
                 <Grid.RowDefinitions>
                     <RowDefinition Height="Auto"/>
                     <RowDefinition Height="*"/>
                     <RowDefinition Height="Auto"/>
                 </Grid.RowDefinitions>
                 
                 <TextBlock x:Uid="Settings_ManageTags" Style="{ThemeResource BodyStrongTextBlockStyle}" Margin="0,0,0,10"/>

                 <ListView Grid.Row="1" ItemsSource="{x:Bind Tags}" SelectionMode="None">
                     <ListView.ItemTemplate>
                         <DataTemplate x:DataType="models:CustomAppTag">
                             <Grid Margin="0,4">
                                 <Grid.ColumnDefinitions>
                                     <ColumnDefinition Width="Auto"/> <!-- Color -->
                                     <ColumnDefinition Width="*"/>    <!-- Name -->
                                     <ColumnDefinition Width="Auto"/> <!-- Delete -->
                                 </Grid.ColumnDefinitions>
                                 
                                 <Button Grid.Column="0" Width="32" Height="32" CornerRadius="16" Margin="0,0,12,0" Padding="0"
                                         Background="{x:Bind helpers:AppTagHelper.GetBrush(HexColor), Mode=OneWay}">
                                     <Button.Flyout>
                                         <Flyout Closed="ColorPickerFlyout_Closed">
                                             <ColorPicker ColorSpectrumShape="Ring" IsMoreButtonVisible="True" IsColorSliderVisible="True" IsColorChannelTextInputVisible="False" 
                                                          ColorChanged="ColorPicker_ColorChanged" Tag="{x:Bind Id}"/>
                                         </Flyout>
                                     </Button.Flyout>
                                 </Button>
                                 
                                 <TextBox Grid.Column="1" Text="{x:Bind Name, Mode=TwoWay}" LostFocus="TagName_LostFocus" VerticalAlignment="Center"/>
                                 
                                 <Button Grid.Column="2" Content="&#xE74D;" FontFamily="Segoe MDL2 Assets" Click="BtnDeleteTag_Click" Tag="{x:Bind Id}" Margin="10,0,0,0" Background="Transparent"/>
                             </Grid>
                         </DataTemplate>
                     </ListView.ItemTemplate>
                 </ListView>
                 
                 <Button Grid.Row="2" x:Uid="Settings_AddTag" Click="BtnAddTag_Click" Margin="0,10,0,0"/>
             </Grid>


             <!-- About -->
             <TextBlock x:Uid="Settings_About" Style="{ThemeResource SubtitleTextBlockStyle}" Margin="0,10,0,5"/>
             <StackPanel Spacing="5">
                  <TextBlock x:Name="TxtCurrentVersion" Text="App Version: ..." Style="{ThemeResource BodyTextBlockStyle}"/>
                  <TextBlock x:Uid="Settings_CreatedBy" Style="{ThemeResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                  <TextBlock x:Uid="Settings_Copyright" Style="{ThemeResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                  <HyperlinkButton x:Uid="Settings_SourceCode" NavigateUri="https://github.com/Some1sm/Windows-Digital-Wellbeing"/>
             </StackPanel>

        </StackPanel>
        </ScrollViewer>
    </Grid>
</Page>
